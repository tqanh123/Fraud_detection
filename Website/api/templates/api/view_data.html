{% extends "index.html" %}
{% load static %}

{% block title %}
Home | Fraud Detection System
{% endblock %}

{% block css %}
<link href="{% static 'assets/css/teststyle.css' %}" rel="stylesheet">
<link href="{% static 'assets/css/style.css' %}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
<main id="main">
    <!-- ======= Hero Section ======= -->
    <section id="homesection" style="padding: 0px 0px;"></section>
    <!--__________________________________ header-box______________________________________________ -->
    <div id="header-container">
        <h1 id="header2">VIEW DATA</h1>
    </div>
    <div class="container" style="
                            margin-top: 20px;
                            margin-bottom: 70px;
                            display: flex;
                            width: 100%;
                            max-width: 1600px;">
        <!-- Data Table -->
        <div style="width: 60%;">
            <table id="example"
                class="table table-striped table-bordered dt-responsive nowrap table-wrapper-scroll-y my-custom-scrollbar"
                style="width: 100%; margin: 0px">
            </table>
        </div>
        <!-- Filter Section and Chart -->
        <div style="display: flex; margin-left: 30px; margin-bottom: 20px; flex-direction: column; width: 30%;">
            <form id="filterForm" class="filter-container" style=" display: flex; flex-direction: column; margin-bottom: 30px; ">
                <div style="display: flex;
                            justify-content: space-between;">
                    <select id="customerFilter" name="customer_id" class="form-control" style="display: inline-block; width: 200px; margin-right: 10px;">
                        <option value="">Select Customer ID</option>
                    </select>
                    <select id="monthFilter" name="tx_month" class="form-control" style="display: inline-block; width: 200px; margin-right: 10px;">
                        <option value="">Select Month</option>
                    </select>
                </div>
                <button type="submit" id="filterButton" class="btn btn-primary" style="width: 80px; margin-top: 20px;">Filter</button>
            </form>
            <div style="max-width: 600px; border: 1px solid #ccc; border-radius: 5px; padding: 10px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="text-align: center; margin-bottom: 10px;">Transaction Distribution of Fraud Scenario</h3>
                <canvas id="pieChart" style="max-width: 100%;"></canvas>
            </div>
        </div>
    </div>
    </section><!-- End Hero -->
</main>
<script>
    $(document).ready(function () {
        var columns = [
            { title: "Sr No." },
            {% for col in columns %}
            { title: "{{ col }}" },
            {% endfor %}
        ];

        var table = $('#example').DataTable({
            serverSide: true,
            processing: true,
            searching: false,
            ajax: {
                url: "{% url 'retrieve_data_by_id' id %}",
                type: 'GET',
                data: function (d) {
                    d.customer_id = $('#customerFilter').val();
                    d.tx_month = $('#monthFilter').val();
                }
            },
            columns: columns,
            dom: 'Bfrtip',
            buttons: [],
            pageLength: 50,
            lengthMenu: [[50, 100, 250, 500, 1000], [50, 100, 250, 500, 1000]],
            initComplete: function () {
                var btns = $('.dt-button');
                btns.addClass('btn btn-primary btn-sm');
                btns.removeClass('dt-button');
            }
        });

        // Populate Customer ID and Month filters dynamically
        function populateFilters() {
            $.get("{% url 'retrieve_data_by_id' id %}", function (response) {
                const data = response.data;
                const customerIndex = columns.findIndex(col => col.title === 'CUSTOMER_ID');
                const dateIndex = columns.findIndex(col => col.title === 'TX_DATETIME');

                const customerIds = [...new Set(data.map(row => row[customerIndex]))];
                $('#customerFilter').html('<option value="">Select Customer ID</option>');
                customerIds.forEach(id => {
                    $('#customerFilter').append(`<option value="${id}">${id}</option>`);
                });

                // Populate Months (MM-YYYY format)
                const months = [...new Set(data.map(row => {
                    const date = new Date(row[dateIndex]);
                    if (!isNaN(date)) { // Ensure the date is valid
                        const month = String(date.getMonth() + 1).padStart(2, '0'); // Two-digit month
                        const year = date.getFullYear();
                        return `${month}-${year}`;
                    }
                    return null; // Skip invalid dates
                }).filter(Boolean))]; // Remove null values
                $('#monthFilter').html('<option value="">Select Month</option>');
                months.forEach(month => {
                    $('#monthFilter').append(`<option value="${month}">${month}</option>`);
                });
            });
        }

        populateFilters();

        // Handle filtering on form submit
        $('#filterForm').on('submit', function (e) {
            e.preventDefault();
            table.ajax.reload();
        });

        // Render pie chart after filtering
        table.on('xhr', function () {
            var data = table.ajax.json().data;
            var lastColumnData = data.map(row => row[row.length - 1]); // last column
            var counts = {};
            lastColumnData.forEach(val => {
                counts[val] = (counts[val] || 0) + 1;
            });

            var labels = Object.keys(counts);
            var values = Object.values(counts);

            // Destroy previous chart if exists
            if (window.pieChartInstance) {
                window.pieChartInstance.destroy();
            }

            var ctx = document.getElementById('pieChart').getContext('2d');
            window.pieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    var total = values.reduce((a, b) => a + b, 0);
                                    var value = values[tooltipItem.dataIndex];
                                    var percentage = ((value / total) * 100).toFixed(2);
                                    return `${labels[tooltipItem.dataIndex]}: ${percentage}%`;
                                }
                            }
                        }
                    }
                }
            });
        });
    });
</script>
{% endblock %}

